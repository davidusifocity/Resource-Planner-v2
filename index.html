<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSU Resource Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo:wght@500;600;700;800&family=Lato:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="dashboard">
        <aside class="sidebar">
            <div class="logo">
                <h1>CSU RESOURCE PLANNER<span>Change Support Unit</span></h1>
                <div class="last-updated" id="lastUpdated">Last updated: --</div>
            </div>
            <nav class="nav-section">
                <div class="nav-label">OVERVIEW</div>
                <div class="nav-item active" data-page="dashboard">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                    Dashboard
                </div>
                <div class="nav-item" data-page="pipeline">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                    Work Backlog
                </div>
                <div class="nav-item" data-page="kanban">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="5" height="18" rx="1"/><rect x="10" y="3" width="5" height="12" rx="1"/><rect x="17" y="3" width="5" height="15" rx="1"/></svg>
                    Kanban View
                </div>
                <div class="nav-item" data-page="resources">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                    Resources
                </div>
            </nav>
            <nav class="nav-section">
                <div class="nav-label">ANALYSIS</div>
                <div class="nav-item" data-page="capacity">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                    Capacity
                </div>
            </nav>
            <div class="quick-stats">
                <div class="nav-label">QUICK STATS</div>
                <div class="stat-mini"><span class="stat-mini-label">Team Days/Wk</span><span class="stat-mini-value" id="sidebarDays">0</span></div>
                <div class="stat-mini"><span class="stat-mini-label">Avg Utilisation</span><span class="stat-mini-value amber" id="sidebarUtil">0%</span></div>
                <div class="stat-mini"><span class="stat-mini-label">Over-allocated</span><span class="stat-mini-value red" id="sidebarRisk">0</span></div>
            </div>
        </aside>

        <main class="main-content">
            <!-- DASHBOARD -->
            <div class="page-view active" id="page-dashboard">
                <header class="header">
                    <div class="header-left"><h2>Dashboard</h2><p>4-week rolling view</p></div>
                    <div class="header-actions">
                        <button class="btn" onclick="exportAllData()">Export All</button>
                        <button class="btn btn-primary" onclick="openWorkItemModal()">+ Work Item</button>
                    </div>
                </header>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">Work Items</div><div class="stat-value" id="statWorkItems">0</div><div class="stat-sub">In progress or upcoming</div></div>
                    <div class="stat-card"><div class="stat-label">Team Days/Week</div><div class="stat-value" id="statDays">0</div><div class="stat-sub">Total available capacity</div></div>
                    <div class="stat-card"><div class="stat-label">Avg Utilisation</div><div class="stat-value" id="statLoad">0%</div><div class="stat-sub">Based on FTE allocation</div></div>
                    <div class="stat-card"><div class="stat-label">Over-allocated</div><div class="stat-value" id="statRisks">0</div><div class="stat-sub">Resources above 100%</div></div>
                </div>
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-header"><span class="card-title">WORK BACKLOG</span><button class="card-action" onclick="navigateTo('pipeline')">→</button></div>
                        <div class="card-body">
                            <div class="pipeline-filters" id="dashboardFilters"></div>
                            <div class="pipeline-list" id="pipelineListDashboard"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span class="card-title">ALLOCATION</span><button class="card-action" onclick="navigateTo('resources')">→</button></div>
                        <div class="card-body"><div class="allocation-list" id="allocationListDashboard"></div></div>
                    </div>
                </div>
                <div class="card" style="margin-top:18px">
                    <div class="card-header"><span class="card-title">UTILISATION HEATMAP</span><button class="card-action" onclick="navigateTo('capacity')">→</button></div>
                    <div class="card-body"><div class="heatmap-container"><table class="heatmap-table" id="heatmapTable"></table></div></div>
                </div>
            </div>

            <!-- BACKLOG -->
            <div class="page-view" id="page-pipeline">
                <header class="header">
                    <div class="header-left"><h2>Work Backlog</h2><p>All work items</p></div>
                    <div class="header-actions">
                        <button class="btn" onclick="downloadTemplate('workitems')">Template</button>
                        <label class="btn" style="cursor:pointer"><input type="file" accept=".csv" style="display:none" onchange="importWorkItemsCSV(this)">Import CSV</label>
                        <button class="btn btn-primary" onclick="openWorkItemModal()">+ Work Item</button>
                    </div>
                </header>
                <div class="full-card">
                    <div class="card-header"><span class="card-title">ALL WORK</span></div>
                    <div class="card-body">
                        <div class="pipeline-filters" id="pipelineFiltersPage"></div>
                        <div class="pipeline-list" id="pipelineListPage"></div>
                    </div>
                </div>
            </div>

            <!-- KANBAN -->
            <div class="page-view" id="page-kanban">
                <header class="header">
                    <div class="header-left"><h2>Kanban View</h2><p>Work items by status</p></div>
                    <div class="header-actions"><div class="pipeline-filters" id="kanbanFilters"></div></div>
                </header>
                <div class="kanban-container" id="kanbanContainer"></div>
            </div>

            <!-- RESOURCES -->
            <div class="page-view" id="page-resources">
                <header class="header">
                    <div class="header-left"><h2>Resources</h2><p>Team members and capacity</p></div>
                    <div class="header-actions">
                        <button class="btn" onclick="downloadTemplate('resources')">Template</button>
                        <label class="btn" style="cursor:pointer"><input type="file" accept=".csv" style="display:none" onchange="importResourcesCSV(this)">Import CSV</label>
                        <button class="btn btn-primary" onclick="openResourceModal()">+ Add Resource</button>
                    </div>
                </header>
                <div class="resources-grid" id="resourcesGrid"></div>
            </div>

            <!-- CAPACITY -->
            <div class="page-view" id="page-capacity">
                <header class="header">
                    <div class="header-left"><h2>Capacity Report</h2><p>FTE % utilisation per week</p></div>
                    <div class="header-actions"><button class="btn" onclick="exportCapacity()">Export CSV</button></div>
                </header>
                <div class="full-card">
                    <div class="card-header"><span class="card-title">WEEKLY UTILISATION (FTE %)</span></div>
                    <div class="card-body"><div class="heatmap-container"><table class="heatmap-table" id="heatmapTableFull"></table></div></div>
                </div>
            </div>
        </main>
    </div>

    <!-- WORK ITEM MODAL -->
    <div class="modal-overlay" id="workItemModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="wiModalTitle">New Work Item</h3>
                <button class="modal-close" onclick="closeModal('workItemModal')">×</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editWiId">
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" class="form-input" id="wiTitle" placeholder="e.g. HR Dashboard Phase 2">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Portfolio Item</label>
                        <select class="form-select" id="wiPortfolioItem">
                            <option value="pstom">PSTOM</option>
                            <option value="integration">Integration</option>
                            <option value="strategic">Strategic</option>
                            <option value="adhoc">Ad-hoc</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Size / Effort</label>
                        <select class="form-select" id="wiSize" onchange="updateEstimation()">
                            <option value="XS">XS — Extra Small (1d)</option>
                            <option value="S">S — Small (3d)</option>
                            <option value="M" selected>M — Medium (7d)</option>
                            <option value="L">L — Large (15d)</option>
                            <option value="XL">XL — Extra Large (30d)</option>
                            <option value="XXL">XXL — Programme (50d)</option>
                        </select>
                        <div class="form-hint" id="sizeHint">M = 7 effort days</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Duration (working days)</label>
                        <input type="number" class="form-input" id="wiDuration" value="20" min="1" max="260" step="1" oninput="updateEstimation()">
                        <div class="form-hint">Working days the item spans</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="wiStatus" onchange="onStatusChange()">
                            <option value="upcoming">Upcoming</option>
                            <option value="progress">In Progress</option>
                            <option value="blocked">Blocked</option>
                            <option value="complete">Complete</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-input" id="wiStartDate" onchange="onDateChange()">
                        <div class="form-hint" id="startDateHint">Click to select from calendar</div>
                    </div>
                    <div class="form-group" style="display:flex;align-items:flex-end;padding-bottom:28px">
                        <button class="btn btn-small" type="button" onclick="clearStartDate()" style="width:100%">Clear Date</button>
                    </div>
                </div>

                <!-- Estimation Summary -->
                <div class="estimation-summary" id="estimationSummary">
                    <div class="estimation-row">
                        <span class="estimation-label">Effort Days</span>
                        <span class="estimation-value" id="estEffortDays">7</span>
                    </div>
                    <div class="estimation-row">
                        <span class="estimation-label">Duration</span>
                        <span class="estimation-value" id="estDuration">20 days</span>
                    </div>
                    <div class="estimation-row">
                        <span class="estimation-label">FTE % Required</span>
                        <span class="estimation-value estimation-highlight" id="estFTE">35%</span>
                    </div>
                </div>

                <!-- Resource Assignments -->
                <div class="form-group">
                    <label class="form-label">Resource Assignments</label>
                    <div class="effort-section">
                        <div class="effort-header">
                            <span>Assign resources — load splits evenly</span>
                            <button class="btn btn-small" onclick="addAssignmentRow()">+ Add Resource</button>
                        </div>
                        <div id="assignmentRows"></div>
                        <div class="effort-total">
                            <span class="effort-total-label">FTE % per person</span>
                            <span class="effort-total-value" id="ftePerPerson">--</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('workItemModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveWorkItem()">Save</button>
            </div>
        </div>
    </div>

    <!-- RESOURCE MODAL -->
    <div class="modal-overlay" id="resourceModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="resModalTitle">New Resource</h3>
                <button class="modal-close" onclick="closeModal('resourceModal')">×</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editResId">
                <div class="form-group">
                    <label class="form-label">Role *</label>
                    <select class="form-select" id="resRole" onchange="updateAutoId()">
                        <option value="">-- Select Role --</option>
                        <option value="Director of Change">Director of Change</option>
                        <option value="Head of Change">Head of Change</option>
                        <option value="Head of PMO">Head of PMO</option>
                        <option value="Project Manager">Project Manager</option>
                        <option value="Change Manager">Change Manager</option>
                        <option value="Project Business Analyst">Project Business Analyst</option>
                        <option value="Project Support Officer">Project Support Officer</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Auto-Generated ID</label>
                        <div class="auto-id-display">
                            <span class="auto-id-value" id="autoIdValue">--</span>
                            <span class="auto-id-hint">Based on role</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-input" id="resName" placeholder="e.g. David Usifo">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Total FTE</label>
                        <input type="number" class="form-input" id="resFTE" step="0.1" value="1.0" min="0.1" max="1.0">
                        <div class="form-hint">1.0 FTE = 35 hrs/week = 5 days</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Baseline Commitment</label>
                        <input type="number" class="form-input" id="resBaseline" step="0.1" value="0" min="0" max="1.0">
                        <div class="form-hint">FTE reserved for BAU work</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('resourceModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveResource()">Save</button>
            </div>
        </div>
    </div>

    <!-- CONFIRM MODAL -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal" style="max-width:460px">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmTitle">Confirm</h3>
                <button class="modal-close" onclick="closeModal('confirmModal')">×</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" style="font-size:var(--fs-small);color:var(--text-secondary);line-height:1.6"></p>
                <div id="confirmDetails" style="margin-top:12px;padding:12px;background:var(--bg-tertiary);border-radius:6px;font-size:var(--fs-xs);color:var(--text-muted);display:none"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="btn btn-danger" id="confirmBtn" onclick="">Confirm</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"><span id="toastMsg"></span><button class="toast-undo" id="toastUndo" onclick="undoLastAction()" style="display:none">Undo</button></div>
    <script src="app.js" defer></script>
</body>
</html>
